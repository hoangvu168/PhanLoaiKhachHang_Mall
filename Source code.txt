import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
import streamlit as st

# Cáº¥u hÃ¬nh trang
st.set_page_config(page_title="PhÃ¢n loáº¡i khÃ¡ch hÃ ng - Mall", layout="wide")

# TiÃªu Ä‘á» chÃ­nh
st.title("á»¨ng dá»¥ng phÃ¢n loáº¡i khÃ¡ch hÃ ng tiá»m nÄƒng tá»« dá»¯ liá»‡u Mall")

# Äá»c dá»¯ liá»‡u
data = pd.read_csv("Mall_Customers.csv")
data.rename(columns={
    'CustomerID': 'MÃ£ KH',
    'Genre': 'Giá»›i tÃ­nh',
    'Age': 'Tuá»•i',
    'Annual Income (k$)': 'Thu nháº­p (k$)',
    'Spending Score (1-100)': 'Äiá»ƒm chi tiÃªu'
}, inplace=True)

# PhÃ¢n cá»¥m KMeans
X = data[['Tuá»•i', 'Thu nháº­p (k$)', 'Äiá»ƒm chi tiÃªu']]
kmeans = KMeans(n_clusters=5, init='k-means++', random_state=42)
data['Cá»¥m'] = kmeans.fit_predict(X)

# LÆ°u káº¿t quáº£ ra file CSV
output_file = "ket_qua_phan_cum.csv"
data.to_csv(output_file, index=False)

# ThÃ´ng bÃ¡o lÆ°u file
st.success(f"Káº¿t quáº£ phÃ¢n cá»¥m Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o file `{output_file}`")

# Bá»™ lá»c dá»¯ liá»‡u
st.sidebar.header(" Bá»™ lá»c dá»¯ liá»‡u")
genders = st.sidebar.multiselect("Giá»›i tÃ­nh", options=data['Giá»›i tÃ­nh'].unique(), default=data['Giá»›i tÃ­nh'].unique())
clusters = st.sidebar.multiselect("Cá»¥m khÃ¡ch hÃ ng", options=sorted(data['Cá»¥m'].unique()), default=sorted(data['Cá»¥m'].unique()))
age_range = st.sidebar.slider("Khoáº£ng tuá»•i", int(data['Tuá»•i'].min()), int(data['Tuá»•i'].max()), (18, 70))
income_range = st.sidebar.slider("Thu nháº­p (k$)", int(data['Thu nháº­p (k$)'].min()), int(data['Thu nháº­p (k$)'].max()), (15, 135))

# Lá»c dá»¯ liá»‡u
filtered_data = data[
    (data['Giá»›i tÃ­nh'].isin(genders)) &
    (data['Cá»¥m'].isin(clusters)) &
    (data['Tuá»•i'].between(age_range[0], age_range[1])) &
    (data['Thu nháº­p (k$)'].between(income_range[0], income_range[1]))
]

# Hiá»ƒn thá»‹ báº£ng dá»¯ liá»‡u
st.subheader(" Dá»¯ liá»‡u khÃ¡ch hÃ ng Ä‘Ã£ phÃ¢n cá»¥m")
st.dataframe(filtered_data, use_container_width=True)

# Biá»ƒu Ä‘á»“ phÃ¢n nhÃ³m khÃ¡ch hÃ ng (2D)
st.subheader(" Biá»ƒu Ä‘á»“ phÃ¢n nhÃ³m khÃ¡ch hÃ ng theo thu nháº­p vÃ  Ä‘iá»ƒm chi tiÃªu")
fig1, ax1 = plt.subplots(figsize=(10, 5))
sns.scatterplot(
    x='Thu nháº­p (k$)', y='Äiá»ƒm chi tiÃªu', hue='Cá»¥m', palette='Set2', data=filtered_data, ax=ax1
)
ax1.set_xlabel("Thu nháº­p (nghÃ¬n Ä‘Ã´)")
ax1.set_ylabel("Äiá»ƒm chi tiÃªu")
ax1.set_title("PhÃ¢n nhÃ³m khÃ¡ch hÃ ng")
st.pyplot(fig1)

# Biá»ƒu Ä‘á»“ phá»¥: countplot theo cá»¥m
st.subheader(" Sá»‘ lÆ°á»£ng khÃ¡ch hÃ ng theo cá»¥m")
fig2, ax2 = plt.subplots()
sns.countplot(x='Cá»¥m', data=filtered_data, palette='Set2', ax=ax2)
ax2.set_title("PhÃ¢n bá»‘ sá»‘ lÆ°á»£ng khÃ¡ch theo tá»«ng cá»¥m")
st.pyplot(fig2)

# Histogram thu nháº­p
st.subheader(" PhÃ¢n phá»‘i thu nháº­p cá»§a khÃ¡ch hÃ ng")
fig3, ax3 = plt.subplots()
sns.histplot(filtered_data['Thu nháº­p (k$)'], kde=True, bins=20, color='skyblue', ax=ax3)
ax3.set_title("PhÃ¢n phá»‘i thu nháº­p")
st.pyplot(fig3)

# Boxplot Ä‘iá»ƒm chi tiÃªu theo cá»¥m
st.subheader(" So sÃ¡nh Ä‘iá»ƒm chi tiÃªu giá»¯a cÃ¡c cá»¥m")
fig4, ax4 = plt.subplots()
sns.boxplot(x='Cá»¥m', y='Äiá»ƒm chi tiÃªu', data=filtered_data, palette='Set2', ax=ax4)
ax4.set_title("So sÃ¡nh Ä‘iá»ƒm chi tiÃªu giá»¯a cÃ¡c cá»¥m")
st.pyplot(fig4)

# MÃ´ táº£ cá»¥m
st.subheader(" Giáº£i thÃ­ch cÃ¡c cá»¥m khÃ¡ch hÃ ng (theo quan sÃ¡t)")
st.markdown("""
- **Cá»¥m 0**: Thu nháº­p tháº¥p, Ä‘iá»ƒm chi tiÃªu tháº¥p â†’ KhÃ¡ch hÃ ng Ã­t tiá»m nÄƒng.
- **Cá»¥m 1**: Thu nháº­p cao, Ä‘iá»ƒm chi tiÃªu cao â†’ KhÃ¡ch hÃ ng VIP, ráº¥t tiá»m nÄƒng.
- **Cá»¥m 2**: Thu nháº­p trung bÃ¬nh, Ä‘iá»ƒm chi tiÃªu cao â†’ KhÃ¡ch hÃ ng yÃªu thÃ­ch mua sáº¯m.
- **Cá»¥m 3**: Thu nháº­p tháº¥p, Ä‘iá»ƒm chi tiÃªu cao â†’ KhÃ¡ch hÃ ng hay mua sáº¯m, nháº¡y cáº£m giÃ¡.
- **Cá»¥m 4**: Thu nháº­p cao, Ä‘iá»ƒm chi tiÃªu tháº¥p â†’ KhÃ¡ch hÃ ng giÃ u nhÆ°ng Ã­t tiÃªu, cáº§n chiáº¿n lÆ°á»£c thÃºc Ä‘áº©y mua sáº¯m.
""")

# NÃºt táº£i káº¿t quáº£
st.download_button(
    label="ğŸ“¥ Táº£i xuá»‘ng káº¿t quáº£ phÃ¢n cá»¥m (.csv)",
    data=filtered_data.to_csv(index=False).encode('utf-8-sig'),
    file_name='ket_qua_phan_cum.csv',
    mime='text/csv'
)

